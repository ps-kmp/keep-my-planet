name: Create Release and Build Artifacts

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  # --- JOB 1: Build Android APK ---
  build_android:
    name: Build Android APK
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Grant execute permission to gradlew
        run: chmod +x gradlew

      - name: Build Android APK
        run: ./gradlew :composeApp:assembleRelease

      - name: Rename APK
        run: mv composeApp/build/outputs/apk/release/composeApp-release.apk keepmyplanet.apk

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: keepmyplanet.apk

  # --- JOB 2: Build Desktop Installers (Windows, Linux, macOS) ---
  build_desktop:
    name: Build Desktop Installer (${{ matrix.os }})
    strategy:
      matrix:
        os: [windows-latest, ubuntu-latest, macos-latest]
        include:
          - os: windows-latest
            task: packageMsi
            artifact_name: keepmyplanet.msi
            asset_path: composeApp/build/compose/binaries/main/native/pt.isel.keepmyplanet-1.0.0.msi
          - os: ubuntu-latest
            task: packageDeb
            artifact_name: keepmyplanet.deb
            asset_path: composeApp/build/compose/binaries/main/native/pt.isel.keepmyplanet-1.0.0.deb
          - os: macos-latest
            task: packageDmg
            artifact_name: keepmyplanet.dmg
            asset_path: composeApp/build/compose/binaries/main/native/pt.isel.keepmyplanet-1.0.0.dmg

    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # Windows: Installs WiX Toolset
      - name: Setup WiX Toolset
        if: runner.os == 'Windows'
        uses: wixtoolset/wix-actions/heat-light-candle@v1

      - name: Grant execute permission to gradlew
        if: runner.os != 'Windows'
        run: chmod +x gradlew

      - name: Build Desktop Package
        run: ./gradlew ${{ matrix.task }}

      - name: Rename Artifact
        run: mv ${{ matrix.asset_path }} ${{ matrix.artifact_name }}
        shell: bash

      - name: Upload Desktop artifact
        uses: actions/upload-artifact@v4
        with:
          name: desktop-${{ matrix.os }}
          path: ${{ matrix.artifact_name }}

  # --- JOB 3: Create GitHub Release ---
  create_release:
    name: Create GitHub Release
    needs: [build_android, build_desktop]
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create Release and Upload Assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          files: |
            artifacts/android-apk/keepmyplanet.apk
            artifacts/desktop-windows-latest/keepmyplanet.msi
            artifacts/desktop-ubuntu-latest/keepmyplanet.deb
            artifacts/desktop-macos-latest/keepmyplanet.dmg